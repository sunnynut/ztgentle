#!/usr/bin/env python
#-*- coding:utf-8 -*-
import sys,re,os
sys.path.append('/home/q/dwetl/lib/py/db')
from Hive import Hive
reload(sys)
sys.path.append('/home/q/dwetl/lib/py/util')
from Time import Time
data_dt=Time.date_format(sys.argv[1].split('.')[0].split('_')[-1]) if len(sys.argv)>1 else Time.yesterday()
yes_date=Time.date_sub(data_dt,1)
del_date=Time.date_sub(data_dt,4)

print data_dt
print yes_date
print del_date

MD5_PATH='/home/q/desdev/sh_script/daily_report/md5.jar'

SQL1="""
use dwd;
create table if not exists dwd_com_team_his_da(
team_id bigint,
last_update_user_id bigint,
title string,
summary string,
city_id bigint,
group_id bigint,
partner_id bigint,
system_flag string,
team_price string,
market_price string,
product_name string,
per_number bigint,
min_number bigint,
max_number bigint,
now_number bigint,
pre_number bigint,
voucher_limit bigint,
express_fare bigint,
express_fare_free_threshold bigint,
bonus bigint,
address string,
team_detail string,
system_review string,
user_review string,
notice string,
express_sms_special_notes string,
delivery string,
peoples_reach_team_flag string,
buy_once_flag string,
team_type string,
sort_order bigint,
expire_time string,
begin_time string,
end_time string,
reach_time string,
close_time string,
seo_title string,
seo_keyword string,
seo_desc string,
ad_title string,
sales string,
publish_flag string,
profit bigint,
hotel_seq string,
order_type string,
hide_partner_flag string,
place_of_departure string,
extra_sms string,
room_type string,
interface_sort_tag string,
check_in_time string,
wireless_team_desc string,
wireless_special_notes string,
wireless_long_latitude string,
travel_days string,
travel_status string,
popularize_flag int,
major_popularize_flag int,
popularize_time string,
earliest_start_time string,
room_desc string,
cost_price string,
red_envelope bigint,
flight_team_price_high string,
flight_market_price_high string,
flight_max_discount string,
flight_max_save string,
hotel_type string,
voucher_val int,
travel_long int,
parent_team_id bigint,
tuan_room_type string,
tuan_project_name string,
tuan_project_desc string,
branch_hotel_names string,
branch_hotel_address string,
baojian_total int,
order_tips string,
qq_team_id bigint,
payment_method string,
payment_condition string,
through_coupon_total int,
sub_title string,
leave_time string,
refund_support_flag int,
traffic_desc string,
sight_desc string,
use_detail string,
good_food_desc string,
hotel_desc string,
hide_room_type_flag string,
need_visa_flag string,
buy_tips string,
is_new_team_flag int,
related_sight string,
publish_2dcode string,
settlement_id bigint,
settlement_days bigint,
ticket_input_time string,
expressno_input_time string,
last_back_time string,
pre_sale_flag string,
use_time_limit string,
travel_nights string,
topic_label string,
purchase_option string,
price_type string,
hide_room_status string,
suggest_reason string,
holiday_tts_flag int,
holiday_tts_multi_price_flag int,
holiday_tts_id string,
hms_can_book_flag tinyint,
hms_unlock_flag tinyint,
detail_table tinyint,
holiday_tts_publish_request_status tinyint,
downline_time string,
express_expire_time string,
holiday_tts_free_package_flag tinyint,
new_type string,
holiday_tts_distribution_way string,
holiday_tts_pay_way string,
holiday_tts_ticket_type string,
tuan_hide_code int,
holiday_tts_ticket_id string,
is_active_hoteldesc tinyint,
team_display_type string,
new_attr string,
partner_source tinyint,
other_tuan_type string,
other_tuan_id bigint,
other_tuan_detail string,
refund_condition string,
other_tuan_data string,
sign_company_flag tinyint,
settlement_type string,
is_union_product_flag tinyint,
tuan_product_type string,
pre_date int,
tel_book_flag tinyint,
version bigint,
url_short string,
other_notice string,
create_time string,
source_type int,
effective_start_date string,
effective_end_date string)
PARTITIONED BY (dt string);
"""
SQL2="""
use tmp;
create table if not exists tmp1_dwd_com_team_his_da(
team_id string,
user_id bigint,
title string,
summary string,
city_id bigint,
group_id bigint,
partner_id bigint,
system string,
team_price double,
market_price double,
product string,
per_number bigint,
min_number bigint,
max_number bigint,
now_number bigint,
pre_number bigint,
card bigint,
fare bigint,
farefree bigint,
bonus bigint,
address string,
detail string,
systemreview string,
userreview string,
notice string,
express string,
delivery string,
conduser string,
buyonce string,
team_type string,
sort_order bigint,
expire_time bigint,
begin_time bigint,
end_time bigint,
reach_time bigint,
close_time bigint,
seo_title string,
seo_keyword string,
seo_description string,
stitle string,
sales string,
publish string,
profit bigint,
hotel_seq string,
order_type string,
hide_partner string,
departure string,
extra_sms string,
room_type string,
sort_tag string,
check_in_time bigint,
wireless_team_desc string,
wireless_special_notes string,
wireless_long_lat string,
travel_days string,
travel_status string,
popularize int,
major_popularize int,
have_popularize bigint,
earliest_start bigint,
room_desc string,
cost_price double,
red_envelope bigint,
team_price_high double,
market_price_high double,
flight_max_discount string,
flight_max_save string,
hotel_type string,
voucher_val int,
travel_long int,
p_team_id bigint,
tuan_room_type string,
tuan_project_name string,
tuan_project_des string,
son_hotel_names string,
son_hotel_address string,
baojian_total int,
tips string,
qqgid bigint,
payment_method string,
payment_condition string,
through_coupon_total int,
subtitle string,
leave_time string,
refund_support int,
traffic_desc string,
scenic_desc string,
money_use_detail string,
good_food string,
hotel_desc string,
hide_room_type string,
if_need_visa boolean,
buy_tips string,
is_new_team int,
related_sight string,
publish_2dcode string,
settlement_id bigint,
settlement_days bigint,
ticket_input_time string,
expressno_input_time string,
last_back_time string,
pre_sale string,
use_time_limit string,
travel_nights string,
topic_label string,
purchase_option string,
price_type string,
hide_room_status string,
suggest_reason string,
holiday_tts int,
tts_mul_price int,
tts_id string,
hms_can_book int,
hms_unlock int,
detail_table int,
holidaytts_publish_request int,
downline_time string,
express_expire_time string,
holidaytts_free_package int,
new_type string,
holidaytts_distribution_way string,
holidaytts_pay_way string,
holiday_tts_ticket_type string,
tuanhide int,
holidaytts_ticket_id string,
is_active_hoteldesc int,
team_display_type string,
new_attr string,
partner_source int,
other_tuan_type string,
other_tuan_id bigint,
other_tuan_detail string,
refund_condition string,
other_tuan_data string,
sign_company int,
settlement_type string,
is_union_product int,
tuan_product_type string,
pre_date int,
tel_book int,
version bigint,
url_short string,
other_notice string,
create_time string,
source_type int,
effective_start_date string);
"""
SQL3="""
from dwd.dwd_com_team_his_da
insert overwrite table tmp.tmp1_dwd_com_team_his_da
select
team_id,
last_update_user_id,
title,
summary,
city_id,
group_id,
partner_id,
system_flag,
team_price,
market_price,
product_name,
per_number,
min_number,
max_number,
now_number,
pre_number,
voucher_limit,
express_fare,
express_fare_free_threshold,
bonus,
address,
team_detail,
system_review,
user_review,
notice,
express_sms_special_notes,
delivery,
peoples_reach_team_flag,
buy_once_flag,
team_type,
sort_order,
expire_time,
begin_time,
end_time,
reach_time,
close_time,
seo_title,
seo_keyword,
seo_desc,
ad_title,
sales,
publish_flag,
profit,
hotel_seq,
order_type,
hide_partner_flag,
place_of_departure,
extra_sms,
room_type,
interface_sort_tag,
check_in_time,
wireless_team_desc,
wireless_special_notes,
wireless_long_latitude,
travel_days,
travel_status,
popularize_flag,
major_popularize_flag,
popularize_time,
earliest_start_time,
room_desc,
cost_price,
red_envelope,
flight_team_price_high,
flight_market_price_high,
flight_max_discount,
flight_max_save,
hotel_type,
voucher_val,
travel_long,
parent_team_id,
tuan_room_type,
tuan_project_name,
tuan_project_desc,
branch_hotel_names,
branch_hotel_address,
baojian_total,
order_tips,
qq_team_id,
payment_method,
payment_condition,
through_coupon_total,
sub_title,
leave_time,
refund_support_flag,
traffic_desc,
sight_desc,
use_detail,
good_food_desc,
hotel_desc,
hide_room_type_flag,
need_visa_flag,
buy_tips,
is_new_team_flag,
related_sight,
publish_2dcode,
settlement_id,
settlement_days,
ticket_input_time,
expressno_input_time,
last_back_time,
pre_sale_flag,
use_time_limit,
travel_nights,
topic_label,
purchase_option,
price_type,
hide_room_status,
suggest_reason,
holiday_tts_flag,
holiday_tts_multi_price_flag,
holiday_tts_id,
hms_can_book_flag,
hms_unlock_flag,
detail_table,
holiday_tts_publish_request_status,
downline_time,
express_expire_time,
holiday_tts_free_package_flag,
new_type,
holiday_tts_distribution_way,
holiday_tts_pay_way,
holiday_tts_ticket_type,
tuan_hide_code,
holiday_tts_ticket_id,
is_active_hoteldesc,
team_display_type,
new_attr,
partner_source,
other_tuan_type,
other_tuan_id,
other_tuan_detail,
refund_condition,
other_tuan_data,
sign_company_flag,
settlement_type,
is_union_product_flag,
tuan_product_type,
pre_date,
tel_book_flag,
version,
url_short,
other_notice,
create_time,
source_type,
effective_start_date
where effective_end_date = '4712-12-31' and dt = '"""+yes_date+"""';
"""
SQL4="""
from dwd.dwd_com_team_his_da
insert overwrite table dwd.dwd_com_team_his_da partition (dt = '"""+data_dt+"""')
select 
    team_id,
    last_update_user_id,
    title,
    summary,
    city_id,
    group_id,
    partner_id,
    system_flag,
    team_price,
    market_price,
    product_name,
    per_number,
    min_number,
    max_number,
    now_number,
    pre_number,
    voucher_limit,
    express_fare,
    express_fare_free_threshold,
    bonus,
    address,
    team_detail,
    system_review,
    user_review,
    notice,
    express_sms_special_notes,
    delivery,
    peoples_reach_team_flag,
    buy_once_flag,
    team_type,
    sort_order,
    expire_time,
    begin_time,
    end_time,
    reach_time,
    close_time,
    seo_title,
    seo_keyword,
    seo_desc,
    ad_title,
    sales,
    publish_flag,
    profit,
    hotel_seq,
    order_type,
    hide_partner_flag,
    place_of_departure,
    extra_sms,
    room_type,
    interface_sort_tag,
    check_in_time,
    wireless_team_desc,
    wireless_special_notes,
    wireless_long_latitude,
    travel_days,
    travel_status,
    popularize_flag,
    major_popularize_flag,
    popularize_time,
    earliest_start_time,
    room_desc,
    cost_price,
    red_envelope,
    flight_team_price_high,
    flight_market_price_high,
    flight_max_discount,
    flight_max_save,
    hotel_type,
    voucher_val,
    travel_long,
    parent_team_id,
    tuan_room_type,
    tuan_project_name,
    tuan_project_desc,
    branch_hotel_names,
    branch_hotel_address,
    baojian_total,
    order_tips,
    qq_team_id,
    payment_method,
    payment_condition,
    through_coupon_total,
    sub_title,
    leave_time,
    refund_support_flag,
    traffic_desc,
    sight_desc,
    use_detail,
    good_food_desc,
    hotel_desc,
    hide_room_type_flag,
    need_visa_flag,
    buy_tips,
    is_new_team_flag,
    related_sight,
    publish_2dcode,
    settlement_id,
    settlement_days,
    ticket_input_time,
    expressno_input_time,
    last_back_time,
    pre_sale_flag,
    use_time_limit,
    travel_nights,
    topic_label,
    purchase_option,
    price_type,
    hide_room_status,
    suggest_reason,
    holiday_tts_flag,
    holiday_tts_multi_price_flag,
    holiday_tts_id,
    hms_can_book_flag,
    hms_unlock_flag,
    detail_table,
    holiday_tts_publish_request_status,
    downline_time,
    express_expire_time,
    holiday_tts_free_package_flag,
    new_type,
    holiday_tts_distribution_way,
    holiday_tts_pay_way,
    holiday_tts_ticket_type,
    tuan_hide_code,
    holiday_tts_ticket_id,
    is_active_hoteldesc,
    team_display_type,
    new_attr,
    partner_source,
    other_tuan_type,
    other_tuan_id,
    other_tuan_detail,
    refund_condition,
    other_tuan_data,
    sign_company_flag,
    settlement_type,
    is_union_product_flag,
    tuan_product_type,
    pre_date,
    tel_book_flag,
    version,
    url_short,
    other_notice,
    create_time,
    source_type,
    effective_start_date,
    effective_end_date
where effective_end_date < '4712-12-31' and dt = '"""+yes_date+"""';
"""
SQL5="""
use tmp;
create table if not exists tmp2_dwd_com_team_his_da(
id bigint,
user_id bigint,
title string,
summary string,
city_id bigint,
group_id bigint,
partner_id bigint,
system string,
team_price double,
market_price double,
product string,
per_number bigint,
min_number bigint,
max_number bigint,
now_number bigint,
pre_number bigint,
card bigint,
fare bigint,
farefree bigint,
bonus bigint,
address string,
detail string,
systemreview string,
userreview string,
notice string,
express string,
delivery string,
conduser string,
buyonce string,
team_type string,
sort_order bigint,
expire_time bigint,
begin_time bigint,
end_time bigint,
reach_time bigint,
close_time bigint,
seo_title string,
seo_keyword string,
seo_description string,
stitle string,
sales string,
publish string,
profit bigint,
hotel_seq string,
order_type string,
hide_partner string,
departure string,
extra_sms string,
room_type string,
sort_tag string,
check_in_time bigint,
wireless_team_desc string,
wireless_special_notes string,
wireless_long_lat string,
travel_days string,
travel_status string,
popularize int,
major_popularize int,
have_popularize bigint,
earliest_start bigint,
room_desc string,
cost_price double,
red_envelope bigint,
team_price_high double,
market_price_high double,
flight_max_discount string,
flight_max_save string,
hotel_type string,
voucher_val int,
travel_long int,
p_team_id bigint,
tuan_room_type string,
tuan_project_name string,
tuan_project_des string,
son_hotel_names string,
son_hotel_address string,
baojian_total int,
tips string,
qqgid bigint,
payment_method string,
payment_condition string,
through_coupon_total int,
subtitle string,
leave_time string,
refund_support int,
traffic_desc string,
scenic_desc string,
money_use_detail string,
good_food string,
hotel_desc string,
hide_room_type string,
if_need_visa boolean,
buy_tips string,
is_new_team int,
related_sight string,
publish_2dcode string,
settlement_id bigint,
settlement_days bigint,
ticket_input_time string,
expressno_input_time string,
last_back_time string,
pre_sale string,
use_time_limit string,
travel_nights string,
topic_label string,
purchase_option string,
price_type string,
hide_room_status string,
suggest_reason string,
holiday_tts int,
tts_mul_price int,
tts_id string,
hms_can_book int,
hms_unlock int,
detail_table int,
holidaytts_publish_request int,
downline_time string,
express_expire_time string,
holidaytts_free_package int,
new_type string,
holidaytts_distribution_way string,
holidaytts_pay_way string,
holiday_tts_ticket_type string,
tuanhide int,
holidaytts_ticket_id string,
is_active_hoteldesc int,
team_display_type string,
new_attr string,
partner_source int,
other_tuan_type string,
other_tuan_id bigint,
other_tuan_detail string,
refund_condition string,
other_tuan_data string,
sign_company int,
settlement_type string,
is_union_product int,
tuan_product_type string,
pre_date int,
tel_book int,
version bigint,
url_short string,
other_notice string,
create_time string,
source_type int,
data_type string);
"""
SQL6="""
add jar """+MD5_PATH+""";
create temporary function md5 as "com.qunar.md5.HiveMD5";
insert overwrite table tmp.tmp2_dwd_com_team_his_da
select 
case when t1.id is not null then t1.id else t2.id end as id,
t1.user_id,
t1.title,
t1.summary,
t1.city_id,
t1.group_id,
t1.partner_id,
t1.system,
t1.team_price,
t1.market_price,
t1.product,
t1.per_number,
t1.min_number,
t1.max_number,
t1.now_number,
t1.pre_number,
t1.card,
t1.fare,
t1.farefree,
t1.bonus,
t1.address,
t1.detail,
t1.systemreview,
t1.userreview,
t1.notice,
t1.express,
t1.delivery,
t1.conduser,
t1.buyonce,
t1.team_type,
t1.sort_order,
t1.expire_time,
t1.begin_time,
t1.end_time,
t1.reach_time,
t1.close_time,
t1.seo_title,
t1.seo_keyword,
t1.seo_description,
t1.stitle,
t1.sales,
t1.publish,
t1.profit,
t1.hotel_seq,
t1.order_type,
t1.hide_partner,
t1.departure,
t1.extra_sms,
t1.room_type,
t1.sort_tag,
t1.check_in_time,
t1.wireless_team_desc,
t1.wireless_special_notes,
t1.wireless_long_lat,
t1.travel_days,
t1.travel_status,
t1.popularize,
t1.major_popularize,
t1.have_popularize,
t1.earliest_start,
t1.room_desc,
t1.cost_price,
t1.red_envelope,
t1.team_price_high,
t1.market_price_high,
t1.flight_max_discount,
t1.flight_max_save,
t1.hotel_type,
t1.voucher_val,
t1.travel_long,
t1.p_team_id,
t1.tuan_room_type,
t1.tuan_project_name,
t1.tuan_project_des,
t1.son_hotel_names,
t1.son_hotel_address,
t1.baojian_total,
t1.tips,
t1.qqgid,
t1.payment_method,
t1.payment_condition,
t1.through_coupon_total,
t1.subtitle,
t1.leave_time,
t1.refund_support,
t1.traffic_desc,
t1.scenic_desc,
t1.money_use_detail,
t1.good_food,
t1.hotel_desc,
t1.hide_room_type,
t1.if_need_visa,
t1.buy_tips,
t1.is_new_team,
t1.related_sight,
t1.publish_2dcode,
t1.settlement_id,
t1.settlement_days,
t1.ticket_input_time,
t1.expressno_input_time,
t1.last_back_time,
t1.pre_sale,
t1.use_time_limit,
t1.travel_nights,
t1.topic_label,
t1.purchase_option,
t1.price_type,
t1.hide_room_status,
t1.suggest_reason,
t1.holiday_tts,
t1.tts_mul_price,
t1.tts_id,
t1.hms_can_book,
t1.hms_unlock,
t1.detail_table,
t1.holidaytts_publish_request,
t1.downline_time,
t1.express_expire_time,
t1.holidaytts_free_package,
t1.new_type,
t1.holidaytts_distribution_way,
t1.holidaytts_pay_way,
t1.holiday_tts_ticket_type,
t1.tuanhide,
t1.holidaytts_ticket_id,
t1.is_active_hoteldesc,
t1.team_display_type,
t1.new_attr,
t1.partner_source,
t1.other_tuan_type,
t1.other_tuan_id,
t1.other_tuan_detail,
t1.refund_condition,
t1.other_tuan_data,
t1.sign_company,
t1.settlement_type,
t1.is_union_product,
t1.tuan_product_type,
t1.pre_date,
t1.tel_book,
t1.version,
t1.url_short,
t1.other_notice,
t1.create_time,
t1.source_type,
case when t1.id is not null and t2.id is null then 'I'
when t1.id is null and t2.id is not null then 'D'
when t1.id is not null and t2.id is not null and md5(
t1.id,
t1.user_id,
t1.title,
t1.summary,
t1.city_id,
t1.group_id,
t1.partner_id,
t1.system,
t1.team_price,
t1.market_price,
t1.product,
t1.per_number,
t1.min_number,
t1.max_number,
t1.now_number,
t1.pre_number,
t1.card,
t1.fare,
t1.farefree,
t1.bonus,
t1.address,
t1.detail,
t1.systemreview,
t1.userreview,
t1.notice,
t1.express,
t1.delivery,
t1.conduser,
t1.buyonce,
t1.team_type,
t1.sort_order,
t1.expire_time,
t1.begin_time,
t1.end_time,
t1.reach_time,
t1.close_time,
t1.seo_title,
t1.seo_keyword,
t1.seo_description,
t1.stitle,
t1.sales,
t1.publish,
t1.profit,
t1.hotel_seq,
t1.order_type,
t1.hide_partner,
t1.departure,
t1.extra_sms,
t1.room_type,
t1.sort_tag,
t1.check_in_time,
t1.wireless_team_desc,
t1.wireless_special_notes,
t1.wireless_long_lat,
t1.travel_days,
t1.travel_status,
t1.popularize,
t1.major_popularize,
t1.have_popularize,
t1.earliest_start,
t1.room_desc,
t1.cost_price,
t1.red_envelope,
t1.team_price_high,
t1.market_price_high,
t1.flight_max_discount,
t1.flight_max_save,
t1.hotel_type,
t1.voucher_val,
t1.travel_long,
t1.p_team_id,
t1.tuan_room_type,
t1.tuan_project_name,
t1.tuan_project_des,
t1.son_hotel_names,
t1.son_hotel_address,
t1.baojian_total,
t1.tips,
t1.qqgid,
t1.payment_method,
t1.payment_condition,
t1.through_coupon_total,
t1.subtitle,
t1.leave_time,
t1.refund_support,
t1.traffic_desc,
t1.scenic_desc,
t1.money_use_detail,
t1.good_food,
t1.hotel_desc,
t1.hide_room_type,
t1.if_need_visa,
t1.buy_tips,
t1.is_new_team,
t1.related_sight,
t1.publish_2dcode,
t1.settlement_id,
t1.settlement_days,
t1.ticket_input_time,
t1.expressno_input_time,
t1.last_back_time,
t1.pre_sale,
t1.use_time_limit,
t1.travel_nights,
t1.topic_label,
t1.purchase_option,
t1.price_type,
t1.hide_room_status,
t1.suggest_reason,
t1.holiday_tts,
t1.tts_mul_price,
t1.tts_id,
t1.hms_can_book,
t1.hms_unlock,
t1.detail_table,
t1.holidaytts_publish_request,
t1.downline_time,
t1.express_expire_time,
t1.holidaytts_free_package,
t1.new_type,
t1.holidaytts_distribution_way,
t1.holidaytts_pay_way,
t1.holiday_tts_ticket_type,
t1.tuanhide,
t1.holidaytts_ticket_id,
t1.is_active_hoteldesc,
t1.team_display_type,
t1.new_attr,
t1.partner_source,
t1.other_tuan_type,
t1.other_tuan_id,
t1.other_tuan_detail,
t1.refund_condition,
t1.other_tuan_data,
t1.sign_company,
t1.settlement_type,
t1.is_union_product,
t1.tuan_product_type,
t1.pre_date,
t1.tel_book,
t1.version,
t1.url_short,
t1.other_notice,
t1.create_time,
t1.source_type) = md5(
t2.id,
t2.user_id,
t2.title,
t2.summary,
t2.city_id,
t2.group_id,
t2.partner_id,
t2.system,
t2.team_price,
t2.market_price,
t2.product,
t2.per_number,
t2.min_number,
t2.max_number,
t2.now_number,
t2.pre_number,
t2.card,
t2.fare,
t2.farefree,
t2.bonus,
t2.address,
t2.detail,
t2.systemreview,
t2.userreview,
t2.notice,
t2.express,
t2.delivery,
t2.conduser,
t2.buyonce,
t2.team_type,
t2.sort_order,
t2.expire_time,
t2.begin_time,
t2.end_time,
t2.reach_time,
t2.close_time,
t2.seo_title,
t2.seo_keyword,
t2.seo_description,
t2.stitle,
t2.sales,
t2.publish,
t2.profit,
t2.hotel_seq,
t2.order_type,
t2.hide_partner,
t2.departure,
t2.extra_sms,
t2.room_type,
t2.sort_tag,
t2.check_in_time,
t2.wireless_team_desc,
t2.wireless_special_notes,
t2.wireless_long_lat,
t2.travel_days,
t2.travel_status,
t2.popularize,
t2.major_popularize,
t2.have_popularize,
t2.earliest_start,
t2.room_desc,
t2.cost_price,
t2.red_envelope,
t2.team_price_high,
t2.market_price_high,
t2.flight_max_discount,
t2.flight_max_save,
t2.hotel_type,
t2.voucher_val,
t2.travel_long,
t2.p_team_id,
t2.tuan_room_type,
t2.tuan_project_name,
t2.tuan_project_des,
t2.son_hotel_names,
t2.son_hotel_address,
t2.baojian_total,
t2.tips,
t2.qqgid,
t2.payment_method,
t2.payment_condition,
t2.through_coupon_total,
t2.subtitle,
t2.leave_time,
t2.refund_support,
t2.traffic_desc,
t2.scenic_desc,
t2.money_use_detail,
t2.good_food,
t2.hotel_desc,
t2.hide_room_type,
t2.if_need_visa,
t2.buy_tips,
t2.is_new_team,
t2.related_sight,
t2.publish_2dcode,
t2.settlement_id,
t2.settlement_days,
t2.ticket_input_time,
t2.expressno_input_time,
t2.last_back_time,
t2.pre_sale,
t2.use_time_limit,
t2.travel_nights,
t2.topic_label,
t2.purchase_option,
t2.price_type,
t2.hide_room_status,
t2.suggest_reason,
t2.holiday_tts,
t2.tts_mul_price,
t2.tts_id,
t2.hms_can_book,
t2.hms_unlock,
t2.detail_table,
t2.holidaytts_publish_request,
t2.downline_time,
t2.express_expire_time,
t2.holidaytts_free_package,
t2.new_type,
t2.holidaytts_distribution_way,
t2.holidaytts_pay_way,
t2.holiday_tts_ticket_type,
t2.tuanhide,
t2.holidaytts_ticket_id,
t2.is_active_hoteldesc,
t2.team_display_type,
t2.new_attr,
t2.partner_source,
t2.other_tuan_type,
t2.other_tuan_id,
t2.other_tuan_detail,
t2.refund_condition,
t2.other_tuan_data,
t2.sign_company,
t2.settlement_type,
t2.is_union_product,
t2.tuan_product_type,
t2.pre_date,
t2.tel_book,
t2.version,
t2.url_short,
t2.other_notice,
t2.create_time,
t2.source_type) then 'R'
when t1.id is not null and t2.id is not null and md5(
t1.id,
t1.user_id,
t1.title,
t1.summary,
t1.city_id,
t1.group_id,
t1.partner_id,
t1.system,
t1.team_price,
t1.market_price,
t1.product,
t1.per_number,
t1.min_number,
t1.max_number,
t1.now_number,
t1.pre_number,
t1.card,
t1.fare,
t1.farefree,
t1.bonus,
t1.address,
t1.detail,
t1.systemreview,
t1.userreview,
t1.notice,
t1.express,
t1.delivery,
t1.conduser,
t1.buyonce,
t1.team_type,
t1.sort_order,
t1.expire_time,
t1.begin_time,
t1.end_time,
t1.reach_time,
t1.close_time,
t1.seo_title,
t1.seo_keyword,
t1.seo_description,
t1.stitle,
t1.sales,
t1.publish,
t1.profit,
t1.hotel_seq,
t1.order_type,
t1.hide_partner,
t1.departure,
t1.extra_sms,
t1.room_type,
t1.sort_tag,
t1.check_in_time,
t1.wireless_team_desc,
t1.wireless_special_notes,
t1.wireless_long_lat,
t1.travel_days,
t1.travel_status,
t1.popularize,
t1.major_popularize,
t1.have_popularize,
t1.earliest_start,
t1.room_desc,
t1.cost_price,
t1.red_envelope,
t1.team_price_high,
t1.market_price_high,
t1.flight_max_discount,
t1.flight_max_save,
t1.hotel_type,
t1.voucher_val,
t1.travel_long,
t1.p_team_id,
t1.tuan_room_type,
t1.tuan_project_name,
t1.tuan_project_des,
t1.son_hotel_names,
t1.son_hotel_address,
t1.baojian_total,
t1.tips,
t1.qqgid,
t1.payment_method,
t1.payment_condition,
t1.through_coupon_total,
t1.subtitle,
t1.leave_time,
t1.refund_support,
t1.traffic_desc,
t1.scenic_desc,
t1.money_use_detail,
t1.good_food,
t1.hotel_desc,
t1.hide_room_type,
t1.if_need_visa,
t1.buy_tips,
t1.is_new_team,
t1.related_sight,
t1.publish_2dcode,
t1.settlement_id,
t1.settlement_days,
t1.ticket_input_time,
t1.expressno_input_time,
t1.last_back_time,
t1.pre_sale,
t1.use_time_limit,
t1.travel_nights,
t1.topic_label,
t1.purchase_option,
t1.price_type,
t1.hide_room_status,
t1.suggest_reason,
t1.holiday_tts,
t1.tts_mul_price,
t1.tts_id,
t1.hms_can_book,
t1.hms_unlock,
t1.detail_table,
t1.holidaytts_publish_request,
t1.downline_time,
t1.express_expire_time,
t1.holidaytts_free_package,
t1.new_type,
t1.holidaytts_distribution_way,
t1.holidaytts_pay_way,
t1.holiday_tts_ticket_type,
t1.tuanhide,
t1.holidaytts_ticket_id,
t1.is_active_hoteldesc,
t1.team_display_type,
t1.new_attr,
t1.partner_source,
t1.other_tuan_type,
t1.other_tuan_id,
t1.other_tuan_detail,
t1.refund_condition,
t1.other_tuan_data,
t1.sign_company,
t1.settlement_type,
t1.is_union_product,
t1.tuan_product_type,
t1.pre_date,
t1.tel_book,
t1.version,
t1.url_short,
t1.other_notice,
t1.create_time,
t1.source_type) != md5(
t2.id,
t2.user_id,
t2.title,
t2.summary,
t2.city_id,
t2.group_id,
t2.partner_id,
t2.system,
t2.team_price,
t2.market_price,
t2.product,
t2.per_number,
t2.min_number,
t2.max_number,
t2.now_number,
t2.pre_number,
t2.card,
t2.fare,
t2.farefree,
t2.bonus,
t2.address,
t2.detail,
t2.systemreview,
t2.userreview,
t2.notice,
t2.express,
t2.delivery,
t2.conduser,
t2.buyonce,
t2.team_type,
t2.sort_order,
t2.expire_time,
t2.begin_time,
t2.end_time,
t2.reach_time,
t2.close_time,
t2.seo_title,
t2.seo_keyword,
t2.seo_description,
t2.stitle,
t2.sales,
t2.publish,
t2.profit,
t2.hotel_seq,
t2.order_type,
t2.hide_partner,
t2.departure,
t2.extra_sms,
t2.room_type,
t2.sort_tag,
t2.check_in_time,
t2.wireless_team_desc,
t2.wireless_special_notes,
t2.wireless_long_lat,
t2.travel_days,
t2.travel_status,
t2.popularize,
t2.major_popularize,
t2.have_popularize,
t2.earliest_start,
t2.room_desc,
t2.cost_price,
t2.red_envelope,
t2.team_price_high,
t2.market_price_high,
t2.flight_max_discount,
t2.flight_max_save,
t2.hotel_type,
t2.voucher_val,
t2.travel_long,
t2.p_team_id,
t2.tuan_room_type,
t2.tuan_project_name,
t2.tuan_project_des,
t2.son_hotel_names,
t2.son_hotel_address,
t2.baojian_total,
t2.tips,
t2.qqgid,
t2.payment_method,
t2.payment_condition,
t2.through_coupon_total,
t2.subtitle,
t2.leave_time,
t2.refund_support,
t2.traffic_desc,
t2.scenic_desc,
t2.money_use_detail,
t2.good_food,
t2.hotel_desc,
t2.hide_room_type,
t2.if_need_visa,
t2.buy_tips,
t2.is_new_team,
t2.related_sight,
t2.publish_2dcode,
t2.settlement_id,
t2.settlement_days,
t2.ticket_input_time,
t2.expressno_input_time,
t2.last_back_time,
t2.pre_sale,
t2.use_time_limit,
t2.travel_nights,
t2.topic_label,
t2.purchase_option,
t2.price_type,
t2.hide_room_status,
t2.suggest_reason,
t2.holiday_tts,
t2.tts_mul_price,
t2.tts_id,
t2.hms_can_book,
t2.hms_unlock,
t2.detail_table,
t2.holidaytts_publish_request,
t2.downline_time,
t2.express_expire_time,
t2.holidaytts_free_package,
t2.new_type,
t2.holidaytts_distribution_way,
t2.holidaytts_pay_way,
t2.holiday_tts_ticket_type,
t2.tuanhide,
t2.holidaytts_ticket_id,
t2.is_active_hoteldesc,
t2.team_display_type,
t2.new_attr,
t2.partner_source,
t2.other_tuan_type,
t2.other_tuan_id,
t2.other_tuan_detail,
t2.refund_condition,
t2.other_tuan_data,
t2.sign_company,
t2.settlement_type,
t2.is_union_product,
t2.tuan_product_type,
t2.pre_date,
t2.tel_book,
t2.version,
t2.url_short,
t2.other_notice,
t2.create_time,
t2.source_type) then 'U'
end as data_type
from
(select * from stg.stg_qunar_group_team_da where dt = '"""+data_dt+"""') t1
full outer join
(select * from stg.stg_qunar_group_team_da where dt = '"""+yes_date+"""') t2
on t1.id = t2.id;
"""
SQL7="""
insert into table dwd.dwd_com_team_his_da partition (dt = '"""+data_dt+"""')
select 
id,
user_id,
title,
summary,
city_id,
group_id,
partner_id,
system,
team_price,
market_price,
product,
per_number,
min_number,
max_number,
now_number,
pre_number,
card,
fare,
farefree,
bonus,
address,
detail,
systemreview,
userreview,
notice,
express,
delivery,
conduser,
buyonce,
team_type,
sort_order,
expire_time,
begin_time,
end_time,
reach_time,
close_time,
seo_title,
seo_keyword,
seo_description,
stitle,
sales,
publish,
profit,
hotel_seq,
order_type,
hide_partner,
departure,
extra_sms,
room_type,
sort_tag,
check_in_time,
wireless_team_desc,
wireless_special_notes,
wireless_long_lat,
travel_days,
travel_status,
popularize,
major_popularize,
have_popularize,
earliest_start,
room_desc,
cost_price,
red_envelope,
team_price_high,
market_price_high,
flight_max_discount,
flight_max_save,
hotel_type,
voucher_val,
travel_long,
p_team_id,
tuan_room_type,
tuan_project_name,
tuan_project_des,
son_hotel_names,
son_hotel_address,
baojian_total,
tips,
qqgid,
payment_method,
payment_condition,
through_coupon_total,
subtitle,
leave_time,
refund_support,
traffic_desc,
scenic_desc,
money_use_detail,
good_food,
hotel_desc,
hide_room_type,
if_need_visa,
buy_tips,
is_new_team,
related_sight,
publish_2dcode,
settlement_id,
settlement_days,
ticket_input_time,
expressno_input_time,
last_back_time,
pre_sale,
use_time_limit,
travel_nights,
topic_label,
purchase_option,
price_type,
hide_room_status,
suggest_reason,
holiday_tts,
tts_mul_price,
tts_id,
hms_can_book,
hms_unlock,
detail_table,
holidaytts_publish_request,
downline_time,
express_expire_time,
holidaytts_free_package,
new_type,
holidaytts_distribution_way,
holidaytts_pay_way,
holiday_tts_ticket_type,
tuanhide,
holidaytts_ticket_id,
is_active_hoteldesc,
team_display_type,
new_attr,
partner_source,
other_tuan_type,
other_tuan_id,
other_tuan_detail,
refund_condition,
other_tuan_data,
sign_company,
settlement_type,
is_union_product,
tuan_product_type,
pre_date,
tel_book,
version,
url_short,
other_notice,
create_time,
source_type,
'"""+data_dt+"""',
'4712-12-31'
from tmp.tmp2_dwd_com_team_his_da
where data_type in ('U', 'I');
"""
print SQL7
SQL8="""
from tmp.tmp2_dwd_com_team_his_da a join tmp.tmp1_dwd_com_team_his_da b on a.id = b.team_id
insert into table dwd.dwd_com_team_his_da partition (dt = '"""+data_dt+"""')
select 
b.team_id,
b.user_id,
b.title,
b.summary,
b.city_id,
b.group_id,
b.partner_id,
b.system,
b.team_price,
b.market_price,
b.product,
b.per_number,
b.min_number,
b.max_number,
b.now_number,
b.pre_number,
b.card,
b.fare,
b.farefree,
b.bonus,
b.address,
b.detail,
b.systemreview,
b.userreview,
b.notice,
b.express,
b.delivery,
b.conduser,
b.buyonce,
b.team_type,
b.sort_order,
b.expire_time,
b.begin_time,
b.end_time,
b.reach_time,
b.close_time,
b.seo_title,
b.seo_keyword,
b.seo_description,
b.stitle,
b.sales,
b.publish,
b.profit,
b.hotel_seq,
b.order_type,
b.hide_partner,
b.departure,
b.extra_sms,
b.room_type,
b.sort_tag,
b.check_in_time,
b.wireless_team_desc,
b.wireless_special_notes,
b.wireless_long_lat,
b.travel_days,
b.travel_status,
b.popularize,
b.major_popularize,
b.have_popularize,
b.earliest_start,
b.room_desc,
b.cost_price,
b.red_envelope,
b.team_price_high,
b.market_price_high,
b.flight_max_discount,
b.flight_max_save,
b.hotel_type,
b.voucher_val,
b.travel_long,
b.p_team_id,
b.tuan_room_type,
b.tuan_project_name,
b.tuan_project_des,
b.son_hotel_names,
b.son_hotel_address,
b.baojian_total,
b.tips,
b.qqgid,
b.payment_method,
b.payment_condition,
b.through_coupon_total,
b.subtitle,
b.leave_time,
b.refund_support,
b.traffic_desc,
b.scenic_desc,
b.money_use_detail,
b.good_food,
b.hotel_desc,
b.hide_room_type,
b.if_need_visa,
b.buy_tips,
b.is_new_team,
b.related_sight,
b.publish_2dcode,
b.settlement_id,
b.settlement_days,
b.ticket_input_time,
b.expressno_input_time,
b.last_back_time,
b.pre_sale,
b.use_time_limit,
b.travel_nights,
b.topic_label,
b.purchase_option,
b.price_type,
b.hide_room_status,
b.suggest_reason,
b.holiday_tts,
b.tts_mul_price,
b.tts_id,
b.hms_can_book,
b.hms_unlock,
b.detail_table,
b.holidaytts_publish_request,
b.downline_time,
b.express_expire_time,
b.holidaytts_free_package,
b.new_type,
b.holidaytts_distribution_way,
b.holidaytts_pay_way,
b.holiday_tts_ticket_type,
b.tuanhide,
b.holidaytts_ticket_id,
b.is_active_hoteldesc,
b.team_display_type,
b.new_attr,
b.partner_source,
b.other_tuan_type,
b.other_tuan_id,
b.other_tuan_detail,
b.refund_condition,
b.other_tuan_data,
b.sign_company,
b.settlement_type,
b.is_union_product,
b.tuan_product_type,
b.pre_date,
b.tel_book,
b.version,
b.url_short,
b.other_notice,
b.create_time,
b.source_type,
b.effective_start_date,
'"""+yes_date+"""'
where data_type = 'U';
"""
SQL9="""
from tmp.tmp2_dwd_com_team_his_da a left outer join tmp.tmp1_dwd_com_team_his_da b on a.id = b.team_id
insert into table dwd.dwd_com_team_his_da partition (dt = '"""+data_dt+"""')
select 
a.id,
a.user_id,
a.title,
a.summary,
a.city_id,
a.group_id,
a.partner_id,
a.system,
a.team_price,
a.market_price,
a.product,
a.per_number,
a.min_number,
a.max_number,
a.now_number,
a.pre_number,
a.card,
a.fare,
a.farefree,
a.bonus,
a.address,
a.detail,
a.systemreview,
a.userreview,
a.notice,
a.express,
a.delivery,
a.conduser,
a.buyonce,
a.team_type,
a.sort_order,
a.expire_time,
a.begin_time,
a.end_time,
a.reach_time,
a.close_time,
a.seo_title,
a.seo_keyword,
a.seo_description,
a.stitle,
a.sales,
a.publish,
a.profit,
a.hotel_seq,
a.order_type,
a.hide_partner,
a.departure,
a.extra_sms,
a.room_type,
a.sort_tag,
a.check_in_time,
a.wireless_team_desc,
a.wireless_special_notes,
a.wireless_long_lat,
a.travel_days,
a.travel_status,
a.popularize,
a.major_popularize,
a.have_popularize,
a.earliest_start,
a.room_desc,
a.cost_price,
a.red_envelope,
a.team_price_high,
a.market_price_high,
a.flight_max_discount,
a.flight_max_save,
a.hotel_type,
a.voucher_val,
a.travel_long,
a.p_team_id,
a.tuan_room_type,
a.tuan_project_name,
a.tuan_project_des,
a.son_hotel_names,
a.son_hotel_address,
a.baojian_total,
a.tips,
a.qqgid,
a.payment_method,
a.payment_condition,
a.through_coupon_total,
a.subtitle,
a.leave_time,
a.refund_support,
a.traffic_desc,
a.scenic_desc,
a.money_use_detail,
a.good_food,
a.hotel_desc,
a.hide_room_type,
a.if_need_visa,
a.buy_tips,
a.is_new_team,
a.related_sight,
a.publish_2dcode,
a.settlement_id,
a.settlement_days,
a.ticket_input_time,
a.expressno_input_time,
a.last_back_time,
a.pre_sale,
a.use_time_limit,
a.travel_nights,
a.topic_label,
a.purchase_option,
a.price_type,
a.hide_room_status,
a.suggest_reason,
a.holiday_tts,
a.tts_mul_price,
a.tts_id,
a.hms_can_book,
a.hms_unlock,
a.detail_table,
a.holidaytts_publish_request,
a.downline_time,
a.express_expire_time,
a.holidaytts_free_package,
a.new_type,
a.holidaytts_distribution_way,
a.holidaytts_pay_way,
a.holiday_tts_ticket_type,
a.tuanhide,
a.holidaytts_ticket_id,
a.is_active_hoteldesc,
a.team_display_type,
a.new_attr,
a.partner_source,
a.other_tuan_type,
a.other_tuan_id,
a.other_tuan_detail,
a.refund_condition,
a.other_tuan_data,
a.sign_company,
a.settlement_type,
a.is_union_product,
a.tuan_product_type,
a.pre_date,
a.tel_book,
a.version,
a.url_short,
a.other_notice,
a.create_time,
a.source_type,
b.effective_start_date,
'4712-12-31'
where data_type = 'R';
"""

#SQL10="""
#use dwd;
#alter table dwd_com_team_his_da drop if exists partition (dt = '"""+del_date+"""');
#"""

sqls=map(lambda r:r[1],sorted([(int(k.split('SQL')[1]),v) for k,v in locals().items() if k.startswith('SQL')],key=lambda r:r[0]))

def main():
    
    hive=Hive()
    hive.set_date(data_dt)
    for sql in sqls:
        hive.add_sql(sql)
    hive.run()
if __name__ == '__main__':
    main()
